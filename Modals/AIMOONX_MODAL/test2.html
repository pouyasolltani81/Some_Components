<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Market Candlestick Chart</title>
  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Moment.js -->
  <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Chart.js Financial Plugin for candlestick charts -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.0"></script>
  <!-- Chart.js Moment Adapter -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0"></script>
  <!-- Axios -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .candle-rect { stroke-width: 1; }
        .bearish { fill: #d75541; stroke: #d75541; }
        .bullish { fill: #50a073; stroke: #50a073; }
        .wick { stroke-width: 1.5; }
        .axis path { stroke: #666; }
    </style>
</head>
<body class="bg-gray-100">
  <div class="container mx-auto p-6">
    <!-- Page Header -->
    <header class="mb-4">
      <h1 class="text-3xl font-bold text-gray-800">Market Candlestick Chart</h1>
    </header>
    <!-- Interactive Controls -->
    <div class="bg-white p-4 rounded-lg shadow mb-4">
      <div class="flex flex-wrap gap-4 items-center">
        <!-- Market Select Dropdown -->
        <div>
          <label for="marketSelect" class="block text-sm font-medium text-gray-700">Select Market</label>
          <select id="marketSelect" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
            <!-- Options populated dynamically -->
          </select>
        </div>
        <!-- Timeframe Input -->
        <div>
          <label for="timeframe" class="block text-sm font-medium text-gray-700">Timeframe</label>
          <input type="text" id="timeframe" value="1m" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
        </div>
        <!-- Since Input -->
        <div>
          <label for="since" class="block text-sm font-medium text-gray-700">Since (YYYY-MM-DD HH:MM:SS)</label>
          <input type="text" id="since" value="2025-02-07 09:52:37" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
        </div>
        <!-- Limit Input -->
        <div>
          <label for="limit" class="block text-sm font-medium text-gray-700">Limit</label>
          <input type="number" id="limit" value="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
        </div>
        <!-- Update Button -->
        <div class="self-end">
          <button id="updateBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Update Chart</button>
        </div>
      </div>
    </div>
    
    <!-- Single Container for Market Info and Candle Chart -->
    <div id="chartContainer" class="bg-white shadow rounded-lg p-6">
      <!-- Market Info -->
      <div id="coinInfo" class="mb-4">
        <h2 id="marketName" class="text-2xl font-semibold text-gray-800"></h2>
        <p id="marketDesc" class="text-gray-600"></p>
      </div>
      <!-- Candle Chart Canvas -->
      <!-- <canvas id="candleChart" class="w-full h-96"></canvas>
        -->
        <div id="candle-chart"></div>
    </div>
  </div>
  
  <!-- JavaScript: Fetch active markets, OHLCV data, and render candlestick chart -->
  <script>
    const token = "6ae3d79118083127c5442c7c6bfaf0b9";
    let activeMarkets = [];
    let currentMarketId = null;
    let candleChart = null;
    
    // Fetch active markets from the API
    async function fetchActiveMarkets() {
      try {
        const response = await axios.get("http://188.34.202.221:8000/Pair/ListPairs/" , {
          headers: {
            'Accept': "application/json",
            'Authorization': token,
          },
        });
        if (response.data.return) {
          activeMarkets = response.data.pairs;
    

          populateMarketSelect();
        }
      } catch (error) {
        console.error("Error fetching active markets:", error);
      }
    }
    
    // Populate the market select dropdown
    function populateMarketSelect() {
      const select = document.getElementById('marketSelect');
      select.innerHTML = ""; // Clear previous options
      activeMarkets.forEach(market => {
        const option = document.createElement('option');
        option.value = market.id;
        option.textContent = market.name;
        select.appendChild(option);
      });
      // Set default market
      if (activeMarkets.length > 0) {
        currentMarketId = activeMarkets[0].id;
        updateMarketInfo(activeMarkets[0]);
      }
    }
    
    // Update the market info display
    function updateMarketInfo(market) {
      document.getElementById('marketName').textContent = market.name;
      document.getElementById('marketDesc').textContent = market.desc || "";
    }
    
    // Fetch OHLCV data using provided parameters and update candlestick chart
    async function fetchOHLCVData() {
      const marketpair_id = currentMarketId;
      const timeframe = document.getElementById('timeframe').value;
      const since = document.getElementById('since').value;
      const limit = document.getElementById('limit').value;
      
      try {
        const response = await axios.post("http://188.34.202.221:8000/Market/exGetOHLCV/", {
          marketpair_id,
          timeframe,
          since,
          limit
        } , {
          headers: {
            'Accept': "application/json",
            'Authorization': token,
          },
        });
        
        if (response.data.return) {
          const ohlcv = response.data.ohlcv;
          // Transform OHLCV data for the candlestick chart plugin
          const candleData = ohlcv.map(item => ({
            x: new Date(item.timestamp),
            o: item.open,
            h: item.high,
            l: item.low,
            c: item.close
          }));
          
          updateCandleChart(candleData);
        }
      } catch (error) {
        console.error("Error fetching OHLCV data:", error);
      }
    }
    
// Register financial components if needed (ensure these exist in Chart.js Financial plugin)
if (Chart.FinancialController && Chart.CandlestickElement) {
  Chart.register(Chart.FinancialController, Chart.CandlestickElement);
}
// function updateCandleChart(candleData) {
//   const ctx = document.getElementById('candleChart').getContext('2d');

//   // Validate data format
//   if (!candleData?.length || !candleData[0]?.x instanceof Date) {
//     console.error("Invalid candle data format. Required: {x: Date, o: number, h: number, l: number, c: number}[]");
//     return;
//   }

//   // Configure colors
//   const datasetConfig = {
//     label: 'Price',
//     data: candleData,
//     borderColor: candleData.map(c => c.o > c.c ? '#D75541' : '#50A073'), // Red/Green borders
//     backgroundColor: candleData.map(c => c.o > c.c ? '#D7554166' : '#50A07366') // Transparent fill
//   };

//   // Update or create chart
//   if (candleChart) {
//     candleChart.data.datasets[0] = datasetConfig;
//     candleChart.update();
//   } else {
//     candleChart = new Chart(ctx, {
//       type: 'candlestick',
//       data: { datasets: [datasetConfig] },
//       options: {
//         responsive: true,
//         scales: {
//           x: {
//             type: 'time',
//             time: { unit: 'minute', tooltipFormat: 'yyyy-MM-dd HH:mm' },
//             ticks: { source: 'data', maxRotation: 0 }
//           },
//           y: { title: { display: true, text: 'Price (USD)' } }
//         }
//       }
//     });
//   }
// }
    

function updateCandleChart(data, width = 800, height = 500) {
    // Clear previous chart
    d3.select("#candle-chart").html("");

    // Set up dimensions
    const margin = { top: 20, right: 20, bottom: 30, left: 40 };
    const chartWidth = width - margin.left - margin.right;
    const chartHeight = height - margin.top - margin.bottom;

    // Create SVG container
    const svg = d3.select("#candle-chart")
        .append("svg")
        .attr("viewBox", `0 0 ${width} ${height}`)
        .attr("preserveAspectRatio", "xMidYMid meet")
        .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

    // Create scales
    const xScale = d3.scaleTime()
        .domain(d3.extent(data, d => d.x))
        .range([0, chartWidth]);

    const yScale = d3.scaleLinear()
        .domain([d3.min(data, d => d.l), d3.max(data, d => d.h)])
        .nice()
        .range([chartHeight, 0]);

    // Calculate candle width
    const candleWidth = chartWidth / data.length * 0.7;

    // Draw candles
    svg.selectAll(".candle")
        .data(data)
        .enter()
        .append("g")
        .attr("class", "candle")
        .attr("transform", d => `translate(${xScale(d.x)},0)`)
        .each(function(d) {
            const isBullish = d.c > d.o;
            const upper = Math.max(d.o, d.c);
            const lower = Math.min(d.o, d.c);
            
            // Candle body
            d3.select(this)
                .append("rect")
                .attr("class", `candle-rect ${isBullish ? 'bullish' : 'bearish'}`)
                .attr("x", -candleWidth/2)
                .attr("y", yScale(upper))
                .attr("width", candleWidth)
                .attr("height", yScale(lower) - yScale(upper));

            // Wick (high-low line)
            d3.select(this)
                .append("line")
                .attr("class", "wick")
                .attr("stroke", isBullish ? "#50a073" : "#d75541")
                .attr("x1", 0)
                .attr("x2", 0)
                .attr("y1", yScale(d.h))
                .attr("y2", yScale(d.l));
        });

    // Add axes
    const xAxis = d3.axisBottom(xScale)
        .tickFormat(d3.timeFormat("%Y-%m-%d %H:%M"));
    
    const yAxis = d3.axisLeft(yScale);

    svg.append("g")
        .attr("class", "axis x-axis")
        .attr("transform", `translate(0,${chartHeight})`)
        .call(xAxis);

    svg.append("g")
        .attr("class", "axis y-axis")
        .call(yAxis);
}

    // Event listeners for the Update button and market selection
    document.getElementById('updateBtn').addEventListener('click', fetchOHLCVData);
    document.getElementById('marketSelect').addEventListener('change', function(e) {
      const selectedId = parseInt(e.target.value);
      currentMarketId = selectedId;
      const market = activeMarkets.find(m => m.id === selectedId);
      updateMarketInfo(market);
      fetchOHLCVData();
    });
    
    // Initial calls
    fetchActiveMarkets();
    // Optionally auto-update OHLCV data every 10 seconds
    setInterval(fetchOHLCVData, 10000);
  </script>
</body>
</html>
