<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Market Candlestick Chart</title>
  <!-- Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <!-- Moment.js -->
  <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Chart.js Financial Plugin for candlestick charts -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.0"></script>
  <!-- Chart.js Moment Adapter -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0"></script>
  <!-- Axios -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-gray-100">
  <div class="container mx-auto p-6">
    <!-- Page Header -->
    <header class="mb-4">
      <h1 class="text-3xl font-bold text-gray-800">Market Candlestick Chart</h1>
    </header>
    <!-- Interactive Controls -->
    <div class="bg-white p-4 rounded-lg shadow mb-4">
      <div class="flex flex-wrap gap-4 items-center">
        <!-- Market Select Dropdown -->
        <div>
          <label for="marketSelect" class="block text-sm font-medium text-gray-700">Select Market</label>
          <select id="marketSelect" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
            <!-- Options populated dynamically -->
          </select>
        </div>
        <!-- Timeframe Input -->
        <div>
          <label for="timeframe" class="block text-sm font-medium text-gray-700">Timeframe</label>
          <input type="text" id="timeframe" value="1m" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
        </div>
        <!-- Since Input -->
        <div>
          <label for="since" class="block text-sm font-medium text-gray-700">Since (YYYY-MM-DD HH:MM:SS)</label>
          <input type="text" id="since" value="2025-02-07 09:52:37" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
        </div>
        <!-- Limit Input -->
        <div>
          <label for="limit" class="block text-sm font-medium text-gray-700">Limit</label>
          <input type="number" id="limit" value="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
        </div>
        <!-- Update Button -->
        <div class="self-end">
          <button id="updateBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">Update Chart</button>
        </div>
      </div>
    </div>
    
    <!-- Single Container for Market Info and Candle Chart -->
    <div id="chartContainer" class="bg-white shadow rounded-lg p-6">
      <!-- Market Info -->
      <div id="coinInfo" class="mb-4">
        <h2 id="marketName" class="text-2xl font-semibold text-gray-800"></h2>
        <p id="marketDesc" class="text-gray-600"></p>
      </div>
      <!-- Candle Chart Canvas -->
      <canvas id="candleChart" class="w-full h-96"></canvas>
    </div>
  </div>
  
  <!-- JavaScript: Fetch active markets, OHLCV data, and render candlestick chart -->
  <script>
    const token = "6ae3d79118083127c5442c7c6bfaf0b9";
    let activeMarkets = [];
    let currentMarketId = null;
    let candleChart = null;
    
    // Fetch active markets from the API
    async function fetchActiveMarkets() {
      try {
        // const response = await axios.get("http://188.34.202.221:8000/Market/GetActiveMarkets/" , {
        //   headers: {
        //     'Accept': "application/json",
        //     'Authorization': token,
        //   },
        // });
        // if (response.data.return) {
        //   activeMarkets = response.data.markets;
          activeMarkets = [
    {
      "id": 1,
      "name": "kucoin",
      "user": {
        "id": 1,
        "uuid": "6e402431-250c-4c52-84dc-e621af5f1aea",
        "email": "admin@admin.com",
        "username": "admin",
        "is_active": true
      },
      "desc": "kucoin admin",
      "api_params": {
        "api_key": "6794bbb3af72b100015101ab",
        "api_secret": "04a5639d-79dd-4e38-a8a1-c706699b06b2",
        "passphrase": "exchange@1"
      },
      "base_url": "http://kucoin.com",
      "is_active": true,
      "ping_at": "2025-01-31T09:36:51.561210+03:30"
    },
    {
      "id": 2,
      "name": "nobitex",
      "user": {
        "id": 1,
        "uuid": "6e402431-250c-4c52-84dc-e621af5f1aea",
        "email": "admin@admin.com",
        "username": "admin",
        "is_active": true
      },
      "desc": "nobitex admin",
      "api_params": {
        "api_key": "Token bd0c716f14512ea784e00c6803f5e2f5b27b46bb",
        "api_secret": "",
        "passphrase": ""
      },
      "base_url": "http://nobitex.com",
      "is_active": true,
      "ping_at": "2025-01-31T09:36:51.967947+03:30"
    }
  ];

          populateMarketSelect();
        // }
      } catch (error) {
        console.error("Error fetching active markets:", error);
      }
    }
    
    // Populate the market select dropdown
    function populateMarketSelect() {
      const select = document.getElementById('marketSelect');
      select.innerHTML = ""; // Clear previous options
      activeMarkets.forEach(market => {
        const option = document.createElement('option');
        option.value = market.id;
        option.textContent = market.name;
        select.appendChild(option);
      });
      // Set default market
      if (activeMarkets.length > 0) {
        currentMarketId = activeMarkets[0].id;
        updateMarketInfo(activeMarkets[0]);
      }
    }
    
    // Update the market info display
    function updateMarketInfo(market) {
      document.getElementById('marketName').textContent = market.name;
      document.getElementById('marketDesc').textContent = market.desc || "";
    }
    
    // Fetch OHLCV data using provided parameters and update candlestick chart
    async function fetchOHLCVData() {
      const marketpair_id = currentMarketId;
      const timeframe = document.getElementById('timeframe').value;
      const since = document.getElementById('since').value;
      const limit = document.getElementById('limit').value;
      
      try {
        const response = await axios.post("http://188.34.202.221:8000/Market/exGetOHLCV/", {
          marketpair_id,
          timeframe,
          since,
          limit
        } , {
          headers: {
            'Accept': "application/json",
            'Authorization': token,
          },
        });
        
        if (response.data.return) {
          const ohlcv = response.data.ohlcv;
          // Transform OHLCV data for the candlestick chart plugin
          const candleData = ohlcv.map(item => ({
            x: new Date(item.timestamp),
            o: item.open,
            h: item.high,
            l: item.low,
            c: item.close
          }));
          
          updateCandleChart(candleData);
        }
      } catch (error) {
        console.error("Error fetching OHLCV data:", error);
      }
    }
    
// Register financial components if needed (ensure these exist in Chart.js Financial plugin)
if (Chart.FinancialController && Chart.CandlestickElement) {
  Chart.register(Chart.FinancialController, Chart.CandlestickElement);
}
function updateCandleChart(candleData) {
  const ctx = document.getElementById('candleChart').getContext('2d');

  // Validate data format
  if (!candleData?.length || !candleData[0]?.x instanceof Date) {
    console.error("Invalid candle data format. Required: {x: Date, o: number, h: number, l: number, c: number}[]");
    return;
  }

  // Configure colors
  const datasetConfig = {
    label: 'Price',
    data: candleData,
    borderColor: candleData.map(c => c.o > c.c ? '#D75541' : '#50A073'), // Red/Green borders
    backgroundColor: candleData.map(c => c.o > c.c ? '#D7554166' : '#50A07366') // Transparent fill
  };

  // Update or create chart
  if (window.candleChart) {
    window.candleChart.data.datasets[0] = datasetConfig;
    window.candleChart.update();
  } else {
    window.candleChart = new Chart(ctx, {
      type: 'candlestick',
      data: { datasets: [datasetConfig] },
      options: {
        responsive: true,
        scales: {
          x: {
            type: 'time',
            time: { unit: 'minute', tooltipFormat: 'yyyy-MM-dd HH:mm' },
            ticks: { source: 'data', maxRotation: 0 }
          },
          y: { title: { display: true, text: 'Price (USD)' } }
        }
      }
    });
  }
}
    
    // Event listeners for the Update button and market selection
    document.getElementById('updateBtn').addEventListener('click', fetchOHLCVData);
    document.getElementById('marketSelect').addEventListener('change', function(e) {
      const selectedId = parseInt(e.target.value);
      currentMarketId = selectedId;
      const market = activeMarkets.find(m => m.id === selectedId);
      updateMarketInfo(market);
      fetchOHLCVData();
    });
    
    // Initial calls
    fetchActiveMarkets();
    // Optionally auto-update OHLCV data every 10 seconds
    setInterval(fetchOHLCVData, 10000);
  </script>
</body>
</html>
