<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Crypto Data Component</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body>
  <div id="parent-component" class="max-w-7xl mx-auto p-6 bg-gray-50"></div>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

  <script>
    class CryptoDataComponent {
      constructor(userToken, coinPair, parentElement) {
        this.userToken = userToken;
        this.coinPair = coinPair;
        this.parentElement = parentElement;
        this.data = null;
      }

      async fetchData() {
        try {
          const params = { name: this.coinPair };
          const response = await axios.post(
            "http://79.175.177.113:15800/AimoonxNewsHUB/Symbols/ex_getSymbolInfo/",
            params,
            {
              headers: {
                Accept: "application/json",
                "Content-Type": "application/json; charset=utf-8",
                Authorization: this.userToken,
              },
            }
          );
          this.data = response.data.data[0];
          this.render();
        } catch (error) {
          console.error('Error fetching data:', error);
          this.parentElement.innerHTML = `<div class="p-4 text-red-500">Error loading data</div>`;
        }
      }

      createDampChart(elementId) {
        const { daily_timeseries } = this.data;
        
        return new ApexCharts(document.querySelector(elementId), {
          chart: {
            type: 'line',
            height: 350,
            toolbar: { show: true }
          },
          series: [
            { name: 'DAMP 5', data: daily_timeseries.damp_5 },
            { name: 'DAMP 10', data: daily_timeseries.damp_10 }
          ],
          xaxis: {
            type: 'datetime',
            categories: daily_timeseries.timestamp.map(t => new Date(t * 1000))
          },
          yaxis: { title: { text: 'DAMP Values' } },
          stroke: { width: 2, curve: 'smooth' },
          colors: ['#3B82F6', '#10B981'],
          tooltip: {
            x: { format: 'dd MMM yyyy' }
          }
        });
      }

      createNewsCountChart(elementId) {
        const { daily_timeseries } = this.data;
        
        return new ApexCharts(document.querySelector(elementId), {
          chart: {
            type: 'bar',
            height: 350,
            toolbar: { show: true }
          },
          series: [{ name: 'News Count', data: daily_timeseries.newsCount }],
          xaxis: {
            type: 'datetime',
            categories: daily_timeseries.timestamp.map(t => new Date(t * 1000))
          },
          yaxis: { title: { text: 'News Count' } },
          colors: ['#F59E0B'],
          plotOptions: {
            bar: { columnWidth: '80%' }
          },
          tooltip: {
            x: { format: 'dd MMM yyyy' }
          }
        });
      }

      createSentimentDonut(elementId) {
        const s = this.data.latest_news_info.last_day_sentiment;
        return new ApexCharts(document.querySelector(elementId), {
          chart: { 
            type: 'donut', 
            height: 250,
            animations: { enabled: false }
          },
          series: [s.positive * 100, s.negative * 100, s.neutral * 100],
          labels: ['Positive', 'Negative', 'Neutral'],
          legend: { position: 'bottom' },
          dataLabels: { enabled: false },
          colors: ['#10B981', '#EF4444', '#64748B'],
          plotOptions: {
            pie: {
              donut: {
                labels: {
                  show: true,
                  total: {
                    show: true,
                    label: 'Sentiment',
                    formatter: () => '100%'
                  }
                }
              }
            }
          }
        });
      }

      render() {
        const { latest_price_info, latest_news_info } = this.data;

        this.parentElement.innerHTML = `
          <!-- Header -->
          <div class="flex items-center mb-8">
            <img src="${this.data.logo}" class="w-16 h-16 mr-4 rounded-full">
            <div>
              <h1 class="text-3xl font-bold">${this.data.name}</h1>
              <p class="text-gray-600 text-sm">${this.data.description}</p>
            </div>
          </div>

          <!-- Price -->
          <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <div class="flex justify-between items-center">
              <div>
                <span class="text-2xl font-bold">$${latest_price_info.formatted_price}</span>
                <span class="ml-2 ${latest_price_info.change_rate >= 0 ? 'text-green-500' : 'text-red-500'}">
                  ${latest_price_info.change_rate}%
                </span>
              </div>
              <div class="text-right">
                <div>24H High: $${latest_price_info.high_price}</div>
                <div>24H Low: $${latest_price_info.low_price}</div>
              </div>
            </div>
          </div>

          <!-- Stats Grid -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- News Stats with Donut -->
            <div class="bg-white p-6 rounded-lg shadow-md">
              <h3 class="text-xl font-semibold mb-4">News Statistics</h3>
              <div class="space-y-4">
                <div>24H News: ${latest_news_info.last_day_count}</div>
                <div>7D Avg: ${latest_news_info.avg_news_week}</div>
                <div id="sentimentChart"></div>
              </div>
            </div>
            
            <!-- Market Stats -->
            <div class="bg-white p-6 rounded-lg shadow-md">
              <h3 class="text-xl font-semibold mb-4">Market Stats</h3>
              <div class="space-y-2">
                <div>Volume: ${latest_price_info.volume}</div>
                <div>Market: ${latest_price_info.market_name}</div>
                <div>Rate: ${this.data.rate}%</div>
              </div>
            </div>

            <!-- Change Stats -->
            <div class="bg-white p-6 rounded-lg shadow-md">
              <h3 class="text-xl font-semibold mb-4">Change Statistics</h3>
              <div class="space-y-2">
                ${Object.entries(latest_news_info.change_stat).map(
                  ([k, v]) => `
                    <div class="flex justify-between">
                      <span>${k.replace(/_/g,' ')}:</span>
                      <span>${v.percent_change_24h?.toFixed(2) || ''}%</span>
                    </div>`
                ).join('')}
              </div>
            </div>
          </div>

          <!-- DAMP Chart -->
          <div id="dampChart" class="bg-white p-6 rounded-lg shadow-md mb-8"></div>
          
          <!-- News Count Chart -->
          <div id="newsCountChart" class="bg-white p-6 rounded-lg shadow-md"></div>
        `;

        // Render charts after DOM update
        setTimeout(() => {
          this.createSentimentDonut('#sentimentChart').render();
          this.createDampChart('#dampChart').render();
          this.createNewsCountChart('#newsCountChart').render();
        }, 100);
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      const parent = document.getElementById('parent-component');
      const cryptoComponent = new CryptoDataComponent(
        '189b4bf96bf5de782515c1b4f0b2a2c7',
        'BTC-USDT',
        parent
      );
      cryptoComponent.fetchData();
    });
  </script>
</body>
</html>